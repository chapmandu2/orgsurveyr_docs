<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulating Organisations With tidygraph and ggraph • orgsurveyr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Simulating Organisations With tidygraph and ggraph">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">orgsurveyr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction_to_orgsurveyr.html">Introduction To orgsurveyr</a>
    </li>
    <li>
      <a href="../articles/organisations_with_ggraph.html">Simulating Organisations With tidygraph and ggraph</a>
    </li>
    <li>
      <a href="../articles/package_setup.html">Setting Up The orgsurveyr Package</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ukgovdatascience/orgsurveyr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Simulating Organisations With tidygraph and ggraph</h1>
                        <h4 class="author">Phil Chapman</h4>
            
            <h4 class="date">2018-11-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ukgovdatascience/orgsurveyr/blob/master/../vignettes/organisations_with_ggraph.Rmd"><code>../vignettes/organisations_with_ggraph.Rmd</code></a></small>
      <div class="hidden name"><code>organisations_with_ggraph.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette demonstrates the basic principles of how organisational data can be analysed and visualised using the <code>ggraph</code> and <code>tidygraph</code> packages. Although the <code>orgsurveyr</code> package provides some convenience functions to facilitate this, it is deliberately kept lightweight with the intention that core <code>ggraph</code> and <code>tidygraph</code> functionality is used instead. Having established the basic principles behind organisational data analyses, these convenience functions and classes are introduced.</p>
</div>
<div id="simulating-the-organisation" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-the-organisation" class="anchor"></a>Simulating The Organisation</h1>
<div id="starting-simple" class="section level2">
<h2 class="hasAnchor">
<a href="#starting-simple" class="anchor"></a>Starting simple</h2>
<div id="creating-a-simple-organisation-with-tidygraph" class="section level3">
<h3 class="hasAnchor">
<a href="#creating-a-simple-organisation-with-tidygraph" class="anchor"></a>Creating a simple organisation with tidygraph</h3>
<p>A simple tree representing an organisation with three teams, each with three sub-teams can be simulated with <code>tidygraph</code> as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tg &lt;-<span class="st"> </span>tidygraph<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tidygraph/topics/create_graphs">create_tree</a></span>(<span class="dt">n =</span> <span class="dv">13</span>, <span class="dt">children =</span> <span class="dv">3</span>)
tg
<span class="co">#&gt; # A tbl_graph: 13 nodes and 12 edges</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # A rooted tree</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Node Data: 13 x 0 (active)</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Edge Data: 12 x 2</span>
<span class="co">#&gt;    from    to</span>
<span class="co">#&gt;   &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1     1     2</span>
<span class="co">#&gt; 2     1     3</span>
<span class="co">#&gt; 3     1     4</span>
<span class="co">#&gt; # ... with 9 more rows</span></code></pre></div>
<p>The network object is two data frames, one for the nodes and another for the edges.</p>
</div>
<div id="plotting-the-simple-organisation-as-a-dendrogram" class="section level3">
<h3 class="hasAnchor">
<a href="#plotting-the-simple-organisation-as-a-dendrogram" class="anchor"></a>Plotting the simple organisation as a dendrogram</h3>
<p>The tidygraph object can be plotted as a dendrogram with <code>ggraph</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggraph</span>(tg, <span class="st">'dendrogram'</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">5</span>, <span class="dt">fill =</span> <span class="st">'white'</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() </code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-2-1.png" width="528"></p>
</div>
<div id="manipulating-the-network-with-tidygraph" class="section level3">
<h3 class="hasAnchor">
<a href="#manipulating-the-network-with-tidygraph" class="anchor"></a>Manipulating the network with tidygraph</h3>
<p>The tidygraph object can be accessed with familiar tidyverse syntax, using the <code>activate</code> verb to select either nodes or edges:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tg <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">activate</span>(edges) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>()
<span class="co">#&gt; # A tibble: 12 x 2</span>
<span class="co">#&gt;     from    to</span>
<span class="co">#&gt;    &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt;  1     1     2</span>
<span class="co">#&gt;  2     1     3</span>
<span class="co">#&gt;  3     1     4</span>
<span class="co">#&gt;  4     2     5</span>
<span class="co">#&gt;  5     2     6</span>
<span class="co">#&gt;  6     2     7</span>
<span class="co">#&gt;  7     3     8</span>
<span class="co">#&gt;  8     3     9</span>
<span class="co">#&gt;  9     3    10</span>
<span class="co">#&gt; 10     4    11</span>
<span class="co">#&gt; 11     4    12</span>
<span class="co">#&gt; 12     4    13</span></code></pre></div>
<p>A number of useful functions exist for calculating over and manipulating the network, and these can be combined with the conventional tidyverse verbs such as <code>mutate</code> and <code>filter</code>. For example, to calculate the depth within the network of each node, we can use the <code>bfs_dist</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tg &lt;-<span class="st"> </span>tg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">depth =</span> tidygraph<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tidygraph/topics/search_graph">bfs_dist</a></span>(<span class="dv">1</span>))
tg
<span class="co">#&gt; # A tbl_graph: 13 nodes and 12 edges</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # A rooted tree</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Node Data: 13 x 1 (active)</span>
<span class="co">#&gt;   depth</span>
<span class="co">#&gt;   &lt;int&gt;</span>
<span class="co">#&gt; 1     0</span>
<span class="co">#&gt; 2     1</span>
<span class="co">#&gt; 3     1</span>
<span class="co">#&gt; 4     1</span>
<span class="co">#&gt; 5     2</span>
<span class="co">#&gt; 6     2</span>
<span class="co">#&gt; # ... with 7 more rows</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Edge Data: 12 x 2</span>
<span class="co">#&gt;    from    to</span>
<span class="co">#&gt;   &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1     1     2</span>
<span class="co">#&gt; 2     1     3</span>
<span class="co">#&gt; 3     1     4</span>
<span class="co">#&gt; # ... with 9 more rows</span></code></pre></div>
<p>Overlaying this new variable onto the network is as would be expected in any ggplot:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggraph</span>(tg, <span class="st">'dendrogram'</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> depth), <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() </code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-5-1.png" width="528"></p>
<p>For more information about how <code>tidygraph</code> represents networks see <a href="https://www.data-imaginist.com/2017/introducing-tidygraph/">this blog post</a>.</p>
</div>
</div>
<div id="larger-organisations" class="section level2">
<h2 class="hasAnchor">
<a href="#larger-organisations" class="anchor"></a>Larger organisations</h2>
<div id="simulating-a-large-organisation" class="section level3">
<h3 class="hasAnchor">
<a href="#simulating-a-large-organisation" class="anchor"></a>Simulating a large organisation</h3>
<p>To create a larger organisation, we can modify the number of nodes in the tree and the maximum number of children per node.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bigger_org &lt;-<span class="st"> </span>tidygraph<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tidygraph/topics/create_graphs">create_tree</a></span>(<span class="dt">n =</span> <span class="dv">40</span>, <span class="dt">children =</span> <span class="dv">4</span>)
<span class="kw">ggraph</span>(bigger_org, <span class="st">'dendrogram'</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">2</span>, <span class="dt">fill =</span> <span class="st">'white'</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() </code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-6-1.png" width="528"></p>
</div>
<div id="simulating-a-symmetrical-organisation" class="section level3">
<h3 class="hasAnchor">
<a href="#simulating-a-symmetrical-organisation" class="anchor"></a>Simulating a symmetrical organisation</h3>
<p>To create a more symmetrical organisation, use the formula below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">n_children &lt;-<span class="st"> </span><span class="dv">4</span>
max_depth &lt;-<span class="st"> </span><span class="dv">3</span>
regular_n &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(n_children<span class="op">^</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span><span class="op">:</span>max_depth))
regular_org &lt;-<span class="st"> </span>tidygraph<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tidygraph/topics/create_graphs">create_tree</a></span>(<span class="dt">n =</span> regular_n, <span class="dt">children =</span> n_children)
<span class="kw">ggraph</span>(regular_org, <span class="st">'dendrogram'</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">2</span>, <span class="dt">fill =</span> <span class="st">'white'</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() </code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-7-1.png" width="528"></p>
<p>The <code>orgsurvey::create_regular_org</code> function provides a wrapper around this approach:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/create_regular_org.html">create_regular_org</a></span>(<span class="dt">n_children =</span> <span class="dv">5</span>, <span class="dt">max_depth =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggraph</span>(<span class="st">'dendrogram'</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">2</span>, <span class="dt">fill =</span> <span class="st">'white'</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() </code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-8-1.png" width="528"></p>
</div>
<div id="plotting-larger-organisations" class="section level3">
<h3 class="hasAnchor">
<a href="#plotting-larger-organisations" class="anchor"></a>Plotting larger organisations</h3>
<p>For larger organisations, a circular dendrograph is preferred as it gives more space for the leaf nodes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggraph</span>(regular_org, <span class="st">'dendrogram'</span>, <span class="dt">circular =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">2</span>, <span class="dt">fill =</span> <span class="st">'white'</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() </code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-9-1.png" width="528"></p>
</div>
</div>
<div id="irregular-organisations" class="section level2">
<h2 class="hasAnchor">
<a href="#irregular-organisations" class="anchor"></a>Irregular organisations</h2>
<div id="general-approach" class="section level3">
<h3 class="hasAnchor">
<a href="#general-approach" class="anchor"></a>General approach</h3>
<p>To create a more realistic and less regular, symmetrical organisation, there are two basic approaches: to either build the network up, or trim an existing network down. In the <code>orgsurveyr</code> package the latter approach is taken. The actions are:</p>
<ul>
<li>Build a regular organisation<br>
</li>
<li>Randomly select units to delete<br>
</li>
<li>Propagate deletion status downwards through the organisation<br>
</li>
<li>Delete the unwanted units</li>
</ul>
</div>
<div id="selecting-nodes-to-delete" class="section level3">
<h3 class="hasAnchor">
<a href="#selecting-nodes-to-delete" class="anchor"></a>Selecting nodes to delete</h3>
<p>To randomly select nodes for deletion, a new variable can be created in the nodes data frame that uses the <code>rbinom</code> function to assign a deletion status of true with a probability of 0.3. Note that the <code>.N()</code> function is used to access the nodes data frame within a tidygraph object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1234</span>)
tg_random_delete &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_regular_org.html">create_regular_org</a></span>(<span class="dv">4</span>,<span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">branch_delete =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>(<span class="dt">n =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(<span class="kw">.N</span>()), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="fl">0.3</span>))

<span class="kw">ggraph</span>(tg_random_delete, <span class="st">'dendrogram'</span>, <span class="dt">circular =</span> <span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(branch_delete)), <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">4</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">title =</span> <span class="st">'Branch Delete'</span>))</code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-10-1.png" width="528"></p>
</div>
<div id="propagating-deletion-status-through-the-organisation" class="section level3">
<h3 class="hasAnchor">
<a href="#propagating-deletion-status-through-the-organisation" class="anchor"></a>Propagating deletion status through the organisation</h3>
<p>The next step is to assign all descendent nodes of a node marked as for deletion the same status. This can be done as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tg_random_branch_delete &lt;-<span class="st"> </span>tg_random_delete <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">to_delete =</span> tidygraph<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tidygraph/topics/map_bfs">map_bfs_dbl</a></span>(<span class="dv">1</span>, <span class="dt">.f =</span> <span class="cf">function</span>(node, path, ...) {
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw">.N</span>()[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(node, path<span class="op">$</span>node),]<span class="op">$</span>branch_delete)
  }))

tg_random_branch_delete <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggraph</span>(<span class="st">'dendrogram'</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(to_delete)), <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">4</span>)  <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">title =</span> <span class="st">'To Delete'</span>))</code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-11-1.png" width="528"></p>
<p>The <code>map_bfs_dbl</code> function allows us to access the nodes between the current node and the root node and identify whether any already have already been marked for deletion. The effect can be seen in the plot, where all four of the leaf nodes in the right hand branch have now been marked for deletion.</p>
</div>
<div id="trimming-nodes-marked-for-deletion" class="section level3">
<h3 class="hasAnchor">
<a href="#trimming-nodes-marked-for-deletion" class="anchor"></a>Trimming nodes marked for deletion</h3>
<p>Deleting nodes is completed using familiar dplyr verbs:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tg_random_branch_delete &lt;-<span class="st"> </span>tg_random_branch_delete <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(to_delete <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>)

<span class="co">#plot</span>
tg_random_branch_delete <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggraph</span>(<span class="st">'dendrogram'</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(to_delete)), <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">4</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">title =</span> <span class="st">'To Delete'</span>))</code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-12-1.png" width="528"></p>
</div>
<div id="more-complex-trimming" class="section level3">
<h3 class="hasAnchor">
<a href="#more-complex-trimming" class="anchor"></a>More complex trimming</h3>
<p>In the example above, any node was given the same chance of being deleted. In reality we may wish to have a difference chance of a node being deleted depending on its depth in the organisation. This can be achieved by first calculating the depth of the organisation using the <code>bfs_dist</code> function, and then either applying some function to this or joining another data frame with the required probabilities.</p>
<div id="trimming-by-a-function-of-depth" class="section level4">
<h4 class="hasAnchor">
<a href="#trimming-by-a-function-of-depth" class="anchor"></a>Trimming by a function of depth</h4>
<p>The first example demonstrates how simple function can be used to translate depth to likelihood of deletion. Nodes to be deleted are highlighted in red.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1234</span>)
tg_trim_by_depth_function &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_regular_org.html">create_regular_org</a></span>(<span class="dv">4</span>, <span class="dv">3</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">depth =</span> <span class="kw">bfs_dist</span>(<span class="dv">1</span>),
         <span class="dt">prob_deletion =</span> <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>(<span class="dv">8</span> <span class="op">-</span><span class="st"> </span>depth) <span class="op">/</span><span class="st"> </span><span class="dv">8</span>,
         <span class="dt">branch_delete =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(<span class="kw">.N</span>()), <span class="dv">1</span>, prob_deletion),
         <span class="dt">to_delete =</span> tidygraph<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tidygraph/topics/map_bfs">map_bfs_dbl</a></span>(<span class="dv">1</span>, <span class="dt">.f =</span> <span class="cf">function</span>(node, path, ...) {
            <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw">.N</span>()[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(node, path<span class="op">$</span>node), ]<span class="op">$</span>branch_delete)
  }))

tg_trim_by_depth_function
<span class="co">#&gt; # A tbl_graph: 85 nodes and 84 edges</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # A rooted tree</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Node Data: 85 x 4 (active)</span>
<span class="co">#&gt;   depth prob_deletion branch_delete to_delete</span>
<span class="co">#&gt;   &lt;int&gt;         &lt;dbl&gt;         &lt;int&gt;     &lt;int&gt;</span>
<span class="co">#&gt; 1     0         0                 0         0</span>
<span class="co">#&gt; 2     1         0.125             0         0</span>
<span class="co">#&gt; 3     1         0.125             0         0</span>
<span class="co">#&gt; 4     1         0.125             0         0</span>
<span class="co">#&gt; 5     1         0.125             0         0</span>
<span class="co">#&gt; 6     2         0.25              1         1</span>
<span class="co">#&gt; # ... with 79 more rows</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Edge Data: 84 x 2</span>
<span class="co">#&gt;    from    to</span>
<span class="co">#&gt;   &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1     1     2</span>
<span class="co">#&gt; 2     1     3</span>
<span class="co">#&gt; 3     1     4</span>
<span class="co">#&gt; # ... with 81 more rows</span>

tg_trim_by_depth_function <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggraph</span>(<span class="st">'dendrogram'</span>, <span class="dt">circular =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> prob_deletion, <span class="dt">color =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(to_delete)), 
                  <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">4</span>, <span class="dt">stroke =</span> <span class="dv">1</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'0'</span> =<span class="st"> 'black'</span>, <span class="st">'1'</span> =<span class="st"> 'red'</span>)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">theme_bw</span>()</code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-13-1.png" width="528"></p>
</div>
<div id="trimming-by-exactly-defined-probabilities" class="section level4">
<h4 class="hasAnchor">
<a href="#trimming-by-exactly-defined-probabilities" class="anchor"></a>Trimming by exactly defined probabilities</h4>
<p>Second, join to a data frame containing the probabilities defined exactly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1234</span>)
tg_trim_by_depth_exact &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_regular_org.html">create_regular_org</a></span>(<span class="dv">4</span>,<span class="dv">3</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">depth =</span> <span class="kw">bfs_dist</span>(<span class="dv">1</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">inner_join</span>(<span class="kw">data_frame</span>(<span class="dt">depth =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">4</span>, 
                        <span class="dt">prob_deletion =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>)), <span class="dt">by =</span> <span class="st">'depth'</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">branch_delete =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(<span class="kw">.N</span>()),<span class="dv">1</span>,prob_deletion),
         <span class="dt">to_delete =</span> tidygraph<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tidygraph/topics/map_bfs">map_bfs_dbl</a></span>(<span class="dv">1</span>, <span class="dt">.f =</span> <span class="cf">function</span>(node, path, ...) {
            <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="kw">.N</span>()[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(node, path<span class="op">$</span>node),]<span class="op">$</span>branch_delete)
  }))

tg_trim_by_depth_exact
<span class="co">#&gt; # A tbl_graph: 85 nodes and 84 edges</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # A rooted tree</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Node Data: 85 x 4 (active)</span>
<span class="co">#&gt;   depth prob_deletion branch_delete to_delete</span>
<span class="co">#&gt;   &lt;int&gt;         &lt;dbl&gt;         &lt;int&gt;     &lt;int&gt;</span>
<span class="co">#&gt; 1     0           0               0         0</span>
<span class="co">#&gt; 2     1           0.1             0         0</span>
<span class="co">#&gt; 3     1           0.1             0         0</span>
<span class="co">#&gt; 4     1           0.1             0         0</span>
<span class="co">#&gt; 5     1           0.1             0         0</span>
<span class="co">#&gt; 6     2           0.2             1         1</span>
<span class="co">#&gt; # ... with 79 more rows</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Edge Data: 84 x 2</span>
<span class="co">#&gt;    from    to</span>
<span class="co">#&gt;   &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1     1     2</span>
<span class="co">#&gt; 2     1     3</span>
<span class="co">#&gt; 3     1     4</span>
<span class="co">#&gt; # ... with 81 more rows</span>

tg_trim_by_depth_exact <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggraph</span>(<span class="st">'dendrogram'</span>, <span class="dt">circular =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> prob_deletion, <span class="dt">color =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(to_delete)), 
                  <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">4</span>, <span class="dt">stroke =</span> <span class="dv">1</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'0'</span> =<span class="st"> 'black'</span>, <span class="st">'1'</span> =<span class="st"> 'red'</span>)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">theme_bw</span>()</code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-14-1.png" width="528"></p>
</div>
<div id="final-complex-organisation" class="section level4">
<h4 class="hasAnchor">
<a href="#final-complex-organisation" class="anchor"></a>Final complex organisation</h4>
<p>Either of the above networks can be trimmed and plotted as a reasonable simulation of an organisation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tg_complex &lt;-<span class="st"> </span>tg_trim_by_depth_function <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(to_delete <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)

tg_complex <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggraph</span>(<span class="st">'dendrogram'</span>, <span class="dt">circular =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">4</span>, <span class="dt">fill =</span> <span class="st">'white'</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">theme_bw</span>()</code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-15-1.png" width="528"></p>
</div>
</div>
</div>
</div>
<div id="simulate-the-people-in-the-organisation" class="section level1">
<h1 class="hasAnchor">
<a href="#simulate-the-people-in-the-organisation" class="anchor"></a>Simulate the people in the organisation</h1>
<div id="introduction-1" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction-1" class="anchor"></a>Introduction</h2>
<p>Having simulated the organisation, we now want to simulate the people within the organisation. It’s the people and what they are doing and saying that we are interested in after all!</p>
</div>
<div id="simulate-group-sizes" class="section level2">
<h2 class="hasAnchor">
<a href="#simulate-group-sizes" class="anchor"></a>Simulate group sizes</h2>
<p>Organisational units within the organisation will have different numbers of people associated with them. Generally, the leaf nodes will have more people, whereas nodes higher up the organisation will have fewer people directly associated with them. This is because there will likely only be one manager and perhaps a secretary or a senior person with no further line management responsibility at a non-leaf node. The leaf nodes, by contrast, will have a number of people with no further line management responsibilities associated with them.</p>
<div id="define-a-function-to-simulate-group-size" class="section level3">
<h3 class="hasAnchor">
<a href="#define-a-function-to-simulate-group-size" class="anchor"></a>Define a function to simulate group size</h3>
<p>Since we don’t want all organisational units to have the same number of people associated with them, let’s define a function to simulate the size of the group whether it is a leaf node or not:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sim_group_size &lt;-<span class="st"> </span><span class="cf">function</span>(is_leaf_node) {
  <span class="cf">if</span> (is_leaf_node) {
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">ceiling</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Beta">rbeta</a></span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">40</span>) <span class="op">*</span><span class="st"> </span><span class="dv">20</span>)
  } <span class="cf">else</span> {
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span>)
  }
}</code></pre></div>
<p>If the group is a leaf node, then the group size will be simulated from the beta distribution, whereas if it isn’t then it will be a number between 1 and 3.</p>
</div>
<div id="test-the-function-for-simulating-group-size" class="section level3">
<h3 class="hasAnchor">
<a href="#test-the-function-for-simulating-group-size" class="anchor"></a>Test the function for simulating group size</h3>
<p>Let’s simulate 10000 groups and see how they are distributed, using the <code><a href="https://www.rdocumentation.org/packages/purrr/topics/map">purrr::map</a></code> function to apply our function 10,000 times:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1337</span>)

<span class="kw">data_frame</span>(<span class="dt">status =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>(<span class="dv">10000</span>, <span class="dv">1</span>, <span class="fl">0.5</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x =</span> purrr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/purrr/topics/map">map_dbl</a></span>(status, sim_group_size)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(x)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>() <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(status)) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>()</code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-17-1.png" width="528"></p>
</div>
<div id="simulate-group-sizes-for-the-network" class="section level3">
<h3 class="hasAnchor">
<a href="#simulate-group-sizes-for-the-network" class="anchor"></a>Simulate group sizes for the network</h3>
<p>The <code>sim_group_size</code> function can be applied to the nodes data frame in the <code>tbl_graph</code> object as if it were a data frame:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tg_group_size &lt;-<span class="st"> </span>tg_complex <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">unit_id =</span> dplyr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/dplyr/topics/ranking">row_number</a></span>(),
         <span class="dt">is_leaf =</span> <span class="kw">node_is_leaf</span>(),
         <span class="dt">unit_size =</span> purrr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/purrr/topics/map">map_dbl</a></span>(is_leaf, sim_group_size))

tg_group_size
<span class="co">#&gt; # A tbl_graph: 55 nodes and 54 edges</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # A rooted tree</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Node Data: 55 x 7 (active)</span>
<span class="co">#&gt;   depth prob_deletion branch_delete to_delete unit_id is_leaf unit_size</span>
<span class="co">#&gt;   &lt;int&gt;         &lt;dbl&gt;         &lt;int&gt;     &lt;int&gt;   &lt;int&gt; &lt;lgl&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt; 1     0         0                 0         0       1 FALSE           2</span>
<span class="co">#&gt; 2     1         0.125             0         0       2 FALSE           2</span>
<span class="co">#&gt; 3     1         0.125             0         0       3 FALSE           1</span>
<span class="co">#&gt; 4     1         0.125             0         0       4 FALSE           1</span>
<span class="co">#&gt; 5     1         0.125             0         0       5 FALSE           2</span>
<span class="co">#&gt; 6     2         0.25              0         0       6 FALSE           2</span>
<span class="co">#&gt; # ... with 49 more rows</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Edge Data: 54 x 2</span>
<span class="co">#&gt;    from    to</span>
<span class="co">#&gt;   &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1     1     2</span>
<span class="co">#&gt; 2     1     3</span>
<span class="co">#&gt; 3     1     4</span>
<span class="co">#&gt; # ... with 51 more rows</span></code></pre></div>
<p>To visualise the group sizes, we can plot them as node labels:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tg_group_size <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggraph</span>(<span class="st">'dendrogram'</span>, <span class="dt">circular =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">6</span>, <span class="dt">fill =</span> <span class="st">'white'</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_node_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> unit_size)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">theme_bw</span>()</code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-19-1.png" width="528"></p>
</div>
</div>
<div id="simulate-the-people-data" class="section level2">
<h2 class="hasAnchor">
<a href="#simulate-the-people-data" class="anchor"></a>Simulate the people data</h2>
<div id="simulating-individual-level-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#simulating-individual-level-variables" class="anchor"></a>Simulating individual level variables</h3>
<p>Now that we have determined how many people should be in each group, we can simulate them. Essentially we need a new data frame with one row per person, rather than one row per organisational unit. There are a variety of ways of doing this, the below example uses <code><a href="https://www.rdocumentation.org/packages/purrr/topics/map">purrr::map</a></code> and <code><a href="https://www.rdocumentation.org/packages/tidyr/topics/unnest">tidyr::unnest</a></code> to simulate an individual level variable with mean of 10 and standard deviation of 3:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tg_individuals_df &lt;-<span class="st"> </span>tg_group_size <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">activate</span>(nodes) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/dplyr/topics/select">select</a></span>(unit_id, unit_size, depth, is_leaf) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">var1 =</span> purrr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(unit_size, <span class="op">~</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(., <span class="dt">mean=</span><span class="dv">10</span>, <span class="dt">sd=</span><span class="dv">3</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tidyr/topics/unnest">unnest</a></span>()
tg_individuals_df
<span class="co">#&gt; # A tibble: 205 x 5</span>
<span class="co">#&gt;    unit_id unit_size depth is_leaf  var1</span>
<span class="co">#&gt;      &lt;int&gt;     &lt;dbl&gt; &lt;int&gt; &lt;lgl&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt;  1       1         2     0 FALSE    4.52</span>
<span class="co">#&gt;  2       1         2     0 FALSE   11.3 </span>
<span class="co">#&gt;  3       2         2     1 FALSE    6.51</span>
<span class="co">#&gt;  4       2         2     1 FALSE   12.0 </span>
<span class="co">#&gt;  5       3         1     1 FALSE   10.8 </span>
<span class="co">#&gt;  6       4         1     1 FALSE   11.7 </span>
<span class="co">#&gt;  7       5         2     1 FALSE    4.48</span>
<span class="co">#&gt;  8       5         2     1 FALSE   11.6 </span>
<span class="co">#&gt;  9       6         2     2 FALSE   16.5 </span>
<span class="co">#&gt; 10       6         2     2 FALSE    4.30</span>
<span class="co">#&gt; # ... with 195 more rows</span></code></pre></div>
</div>
<div id="calculating-group-means-for-the-simulated-variable" class="section level3">
<h3 class="hasAnchor">
<a href="#calculating-group-means-for-the-simulated-variable" class="anchor"></a>Calculating group means for the simulated variable</h3>
<p>To plot the individual level data on the network plot, we first summarise it as the group level and then join it back into the nodes data frame of the network:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#now calculate means and put info back into network plot</span>
tg_var1_df &lt;-<span class="st"> </span>tg_individuals_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(unit_id) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">var1 =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(var1))

<span class="co">#merge in summarised data</span>
tg_var1 &lt;-<span class="st"> </span>tg_group_size <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">inner_join</span>(tg_var1_df, <span class="dt">by =</span> <span class="st">'unit_id'</span>)
tg_var1
<span class="co">#&gt; # A tbl_graph: 55 nodes and 54 edges</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # A rooted tree</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Node Data: 55 x 8 (active)</span>
<span class="co">#&gt;   depth prob_deletion branch_delete to_delete unit_id is_leaf unit_size</span>
<span class="co">#&gt;   &lt;int&gt;         &lt;dbl&gt;         &lt;int&gt;     &lt;int&gt;   &lt;int&gt; &lt;lgl&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt; 1     0         0                 0         0       1 FALSE           2</span>
<span class="co">#&gt; 2     1         0.125             0         0       2 FALSE           2</span>
<span class="co">#&gt; 3     1         0.125             0         0       3 FALSE           1</span>
<span class="co">#&gt; 4     1         0.125             0         0       4 FALSE           1</span>
<span class="co">#&gt; 5     1         0.125             0         0       5 FALSE           2</span>
<span class="co">#&gt; 6     2         0.25              0         0       6 FALSE           2</span>
<span class="co">#&gt; # ... with 49 more rows, and 1 more variable: var1 &lt;dbl&gt;</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Edge Data: 54 x 2</span>
<span class="co">#&gt;    from    to</span>
<span class="co">#&gt;   &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1     1     2</span>
<span class="co">#&gt; 2     1     3</span>
<span class="co">#&gt; 3     1     4</span>
<span class="co">#&gt; # ... with 51 more rows</span>

<span class="co">#plot as a network</span>
tg_var1 <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggraph</span>(<span class="st">'dendrogram'</span>, <span class="dt">circular =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> var1), <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">4</span>) </code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-21-1.png" width="528"></p>
</div>
<div id="calculating-cumulative-means-for-the-simulated-variable" class="section level3">
<h3 class="hasAnchor">
<a href="#calculating-cumulative-means-for-the-simulated-variable" class="anchor"></a>Calculating cumulative means for the simulated variable</h3>
<div id="introduction-to-cumulative-means" class="section level4">
<h4 class="hasAnchor">
<a href="#introduction-to-cumulative-means" class="anchor"></a>Introduction to cumulative means</h4>
<p>Often we don’t necessarily want to know the mean for just the people directly associated with an organisational unit, but the mean for all people associated with the current unit <em>and its children</em>.</p>
</div>
<div id="deriving-a-new-groupindividual-mapping" class="section level4">
<h4 class="hasAnchor">
<a href="#deriving-a-new-groupindividual-mapping" class="anchor"></a>Deriving a new group:individual mapping</h4>
<p>What is required is a data frame that maps each unit with all of the units below it in the hierarchy. This can be achieved using the functionality of the <code><a href="https://www.rdocumentation.org/packages/tidygraph/topics/map_bfs_back">tidygraph::map_bfs_back</a></code> function in a similar way to how we propagated deletion status through the tree:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tg_expanded_df &lt;-<span class="st"> </span>tg_group_size <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">child_id =</span> tidygraph<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tidygraph/topics/map_bfs_back">map_bfs_back</a></span>(unit_id, <span class="dt">.f =</span> <span class="cf">function</span>(node, path, ...) {
    <span class="kw">.N</span>()[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(node, path<span class="op">$</span>node),]<span class="op">$</span>unit_id
  })) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">activate</span>(nodes) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/dplyr/topics/mutate">transmute</a></span>(<span class="dt">parent_id =</span> unit_id, <span class="dt">unit_id =</span> child_id) <span class="op">%&gt;%</span>
<span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tidyr/topics/unnest">unnest</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(parent_id)
tg_expanded_df
<span class="co">#&gt; # A tibble: 196 x 2</span>
<span class="co">#&gt;    parent_id unit_id</span>
<span class="co">#&gt;        &lt;int&gt;   &lt;int&gt;</span>
<span class="co">#&gt;  1         1       1</span>
<span class="co">#&gt;  2         1       2</span>
<span class="co">#&gt;  3         1       3</span>
<span class="co">#&gt;  4         1       4</span>
<span class="co">#&gt;  5         1       5</span>
<span class="co">#&gt;  6         1       6</span>
<span class="co">#&gt;  7         1       7</span>
<span class="co">#&gt;  8         1       8</span>
<span class="co">#&gt;  9         1       9</span>
<span class="co">#&gt; 10         1      10</span>
<span class="co">#&gt; # ... with 186 more rows</span></code></pre></div>
</div>
</div>
<div id="calculating-cumulative-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#calculating-cumulative-variables" class="anchor"></a>Calculating cumulative variables</h3>
<p>We now need to join our individuals data frame with the cumulative mapping data frame, calculate our cumulative variables and then join the result back into the tidygraph object.</p>
<p>First calculate the cumulative variables:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tg_cumulative_df &lt;-<span class="st"> </span>tg_expanded_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">inner_join</span>(tg_individuals_df, <span class="dt">by =</span> <span class="st">'unit_id'</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(parent_id) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">cumulative_group_size =</span> <span class="kw">n</span>(),
            <span class="dt">cumulative_var1_mean =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(var1))
tg_cumulative_df
<span class="co">#&gt; # A tibble: 55 x 3</span>
<span class="co">#&gt;    parent_id cumulative_group_size cumulative_var1_mean</span>
<span class="co">#&gt;        &lt;int&gt;                 &lt;int&gt;                &lt;dbl&gt;</span>
<span class="co">#&gt;  1         1                   205                 9.68</span>
<span class="co">#&gt;  2         2                    46                 9.73</span>
<span class="co">#&gt;  3         3                    58                 9.78</span>
<span class="co">#&gt;  4         4                    33                 9.79</span>
<span class="co">#&gt;  5         5                    66                 9.55</span>
<span class="co">#&gt;  6         6                    10                10.3 </span>
<span class="co">#&gt;  7         7                    17                 9.68</span>
<span class="co">#&gt;  8         8                    17                 9.50</span>
<span class="co">#&gt;  9         9                     9                 9.39</span>
<span class="co">#&gt; 10        10                    16                 9.85</span>
<span class="co">#&gt; # ... with 45 more rows</span></code></pre></div>
</div>
<div id="merge-cumulative-variables-back-into-the-network" class="section level3">
<h3 class="hasAnchor">
<a href="#merge-cumulative-variables-back-into-the-network" class="anchor"></a>Merge cumulative variables back into the network</h3>
<p>Now merge back into the network object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tg_cumulative &lt;-<span class="st"> </span>tg_var1 <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(unit_id, depth, is_leaf, unit_size, var1) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">inner_join</span>(tg_cumulative_df, <span class="dt">by =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'unit_id'</span> =<span class="st"> 'parent_id'</span>)) 
tg_cumulative
<span class="co">#&gt; # A tbl_graph: 55 nodes and 54 edges</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # A rooted tree</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Node Data: 55 x 7 (active)</span>
<span class="co">#&gt;   unit_id depth is_leaf unit_size  var1 cumulative_group… cumulative_var1…</span>
<span class="co">#&gt;     &lt;int&gt; &lt;int&gt; &lt;lgl&gt;       &lt;dbl&gt; &lt;dbl&gt;             &lt;int&gt;            &lt;dbl&gt;</span>
<span class="co">#&gt; 1       1     0 FALSE           2  7.92               205             9.68</span>
<span class="co">#&gt; 2       2     1 FALSE           2  9.25                46             9.73</span>
<span class="co">#&gt; 3       3     1 FALSE           1 10.8                 58             9.78</span>
<span class="co">#&gt; 4       4     1 FALSE           1 11.7                 33             9.79</span>
<span class="co">#&gt; 5       5     1 FALSE           2  8.02                66             9.55</span>
<span class="co">#&gt; 6       6     2 FALSE           2 10.4                 10            10.3 </span>
<span class="co">#&gt; # ... with 49 more rows</span>
<span class="co">#&gt; #</span>
<span class="co">#&gt; # Edge Data: 54 x 2</span>
<span class="co">#&gt;    from    to</span>
<span class="co">#&gt;   &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1     1     2</span>
<span class="co">#&gt; 2     1     3</span>
<span class="co">#&gt; 3     1     4</span>
<span class="co">#&gt; # ... with 51 more rows</span></code></pre></div>
<p>And finally plot - coloured by cumulative mean of the simulated variable, and labelled by cumulative unit size:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tg_cumulative <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggraph</span>(<span class="st">'dendrogram'</span>, <span class="dt">circular =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_edge_diagonal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_node_point</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> cumulative_var1_mean), <span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">size =</span> <span class="dv">6</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_node_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> cumulative_group_size), <span class="dt">color =</span> <span class="st">'white'</span>, <span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>()</code></pre></div>
<p><img src="organisations_with_ggraph_files/figure-html/unnamed-chunk-25-1.png" width="528"></p>
</div>
</div>
</div>
<div id="conclusion" class="section level1">
<h1 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h1>
<p>In this analysis we have simulated basic organisations, made them more complex by trimming, and then simulated individual level data which we have summarised both at immediate group level and cumulative group level. Simulation of more complex variables is possible, for example introducing group level effects or adding additional structure into the organisation.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li>
<a href="#simulating-the-organisation">Simulating The Organisation</a><ul class="nav nav-pills nav-stacked">
<li><a href="#starting-simple">Starting simple</a></li>
      <li><a href="#larger-organisations">Larger organisations</a></li>
      <li><a href="#irregular-organisations">Irregular organisations</a></li>
      </ul>
</li>
      <li>
<a href="#simulate-the-people-in-the-organisation">Simulate the people in the organisation</a><ul class="nav nav-pills nav-stacked">
<li><a href="#introduction-1">Introduction</a></li>
      <li><a href="#simulate-group-sizes">Simulate group sizes</a></li>
      <li><a href="#simulate-the-people-data">Simulate the people data</a></li>
      </ul>
</li>
      <li><a href="#conclusion">Conclusion</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Phil Chapman.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.2.0.9000.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
